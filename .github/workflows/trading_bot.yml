name: NYSE Trading Pipeline

on:
  schedule:
    # Run every hour from 12:00 PM to 8:00 PM UTC
    # This covers 12 PM ET and 3 PM ET in both EST and EDT
    - cron: "0 16-20 * * 1-5"

    # TP/SL monitoring: Run at :35 past each hour from 1:35 PM to 8:35 PM UTC
    # This covers 9:35 AM - 3:35 PM ET in both EST and EDT
    - cron: "35 13-20 * * 1-5"

  workflow_dispatch:
    inputs:
      job_type:
        description: "Which job to run"
        required: true
        default: "pipeline"
        type: choice
        options:
          - pipeline
          - tp_sl

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.job_type == 'pipeline' || github.event_name == 'schedule'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install Dependencies
        run: |
          pip install pandas pandas_market_calendars pytz alpaca-trade-api
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Pipeline
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        run: python pipeline.py

  run-tp-sl:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.job_type == 'tp_sl' || github.event_name == 'schedule'
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install Dependencies
        run: |
          pip install pandas pandas_market_calendars pytz alpaca-trade-api
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run TP/SL Monitor
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        run: python tp_sl.py
