name: NYSE Trading Pipeline

on:
  schedule:
    # Run every hour from 12:00 PM to 8:00 PM UTC
    # This covers 12 PM ET and 3 PM ET in both EST and EDT
    - cron: "0 16-20 * * 1-5"

    # TP/SL monitoring: Run at :35 past each hour from 1:35 PM to 8:35 PM UTC
    # This covers 9:35 AM - 3:35 PM ET in both EST and EDT
    - cron: "35 13-20 * * 1-5"

  workflow_dispatch:
    inputs:
      job_type:
        description: "Which job to run"
        required: true
        default: "pipeline"
        type: choice
        options:
          - pipeline
          - tp_sl

jobs:
  run-pipeline:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.job_type == 'pipeline' || (github.event_name == 'schedule' && github.event.schedule == '0 16-20 * * 1-5')
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install Dependencies
        run: |
          pip install pandas pandas_market_calendars pytz alpaca-trade-api
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run Pipeline
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        run: python pipeline.py

      - name: Commit and Push Tracker Files
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/open_pairs.csv data/trade_history.csv data/execution_log.csv data/kelly_positions.csv data/portfolio_orders.csv || true
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update trading tracker and execution files [skip ci]" && git push)

  run-tp-sl:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.job_type == 'tp_sl' || (github.event_name == 'schedule' && github.event.schedule == '35 13-20 * * 1-5')
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10"
          cache: "pip"

      - name: Install Dependencies
        run: |
          pip install pandas pandas_market_calendars pytz alpaca-trade-api
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Run TP/SL Monitor
        env:
          ALPACA_API_KEY: ${{ secrets.ALPACA_API_KEY }}
          ALPACA_SECRET_KEY: ${{ secrets.ALPACA_SECRET_KEY }}
        run: python tp_sl.py

      - name: Commit and Push Updated Tracker Files
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add data/open_pairs.csv data/trade_history.csv || true
          git diff --quiet && git diff --staged --quiet || (git commit -m "Update tracker after TP/SL check [skip ci]" && git push)
